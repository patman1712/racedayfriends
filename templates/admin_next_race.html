{% extends "base.html" %}

{% block content %}
<div class="container" style="padding-top: 120px; max-width: 800px;">
    <a href="/admin" style="color: var(--rdf-teal); font-weight: bold; margin-bottom: 20px; display: inline-block;">&larr; Zurück zum Dashboard</a>

    <div class="card">
        <div class="card-header">
            <h3>Next Race Widget Bearbeiten</h3>
        </div>
        <div class="card-body">
            <form action="/admin/update_next_race" method="post">
                <div class="form-group">
                    <label>Serie / Label</label>
                    <input type="text" name="series" value="{{ config.next_race.series }}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Event Titel</label>
                    <input type="text" name="title" value="{{ config.next_race.title }}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Strecke</label>
                    <input type="text" name="track" value="{{ config.next_race.track }}" class="form-control">
                </div>
                <div class="form-group">
                    <label>Datum & Uhrzeit (für Countdown)</label>
                    <input type="datetime-local" name="date" value="{{ config.next_race.date }}" class="form-control">
                </div>
                
                <hr style="border-color: var(--rdf-border); margin: 30px 0;">
                
                <div class="form-group">
                    <label>Liga / Organisation</label>
                    <input type="text" name="league" value="{{ config.next_race.league }}" class="form-control" placeholder="z.B. DGTM, VCO, iRacing Official">
                </div>
                
                <!-- Auto Auswahl -->
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Fahrzeugklasse</label>
                        <select id="car_class" name="car_class" class="form-control" onchange="updateCarModels()">
                            <option value="">-- Bitte wählen --</option>
                            {% for class_name in cars_data.keys() %}
                            <option value="{{ class_name }}" {% if config.next_race.car_class == class_name %}selected{% endif %}>{{ class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Fahrzeug</label>
                        <select id="car_model" name="car_model" class="form-control">
                            <option value="{{ config.next_race.car_model }}">{{ config.next_race.car_model or '-- Erst Klasse wählen --' }}</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Twitch Kanal Name (optional)</label>
                    <input type="text" name="twitch" value="{{ config.next_race.twitch }}" class="form-control" placeholder="z.B. racedayfriends (ohne URL)">
                    <small style="color: var(--rdf-silver);">Wird auf der Event-Seite eingebettet.</small>
                </div>

                <div class="form-group">
                    <label>Event Beschreibung</label>
                    <textarea name="description" class="form-control" rows="4">{{ config.next_race.description }}</textarea>
                </div>

                <div class="form-group">
                    <label>Fahrer Lineup (Wer fährt mit?)</label>
                    <div style="background: #0B1829; border: 1px solid var(--rdf-border); padding: 15px; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                        {% for driver in all_drivers %}
                        <div style="margin-bottom: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; text-transform: none;">
                                <input type="checkbox" name="driver_ids" value="{{ driver.id }}" 
                                    {% if driver.id|string in config.next_race.drivers %}checked{% endif %}
                                    style="margin-right: 10px;">
                                {{ driver.name }} <span style="color: var(--rdf-silver); font-size: 0.8em; margin-left: 5px;">(iR: {{ driver.ir_sports }})</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <button type="submit" class="btn-primary">Speichern</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Fahrzeugdaten als JSON Objekt in JS verfügbar machen
    const carsData = {{ cars_data | tojson }};
    
    function updateCarModels() {
        const classSelect = document.getElementById('car_class');
        const modelSelect = document.getElementById('car_model');
        const selectedClass = classSelect.value;
        
        // Reset Models
        modelSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';
        
        if (selectedClass && carsData[selectedClass]) {
            carsData[selectedClass].forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.text = model;
                modelSelect.appendChild(option);
            });
        }
    }
</script>

<style>
    .form-group { margin-bottom: 20px; }
    .form-control {
        width: 100%;
        padding: 12px;
        background: #0B1829;
        border: 1px solid var(--rdf-border);
        color: white;
        border-radius: 4px;
        font-family: var(--font-body);
    }
    .form-control:focus {
        border-color: var(--rdf-teal);
        outline: none;
    }
    label { display: block; margin-bottom: 8px; color: var(--rdf-silver); font-family: var(--font-tech); text-transform: uppercase; letter-spacing: 1px; }
</style>
{% endblock %}